services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      # Supabase PostgreSQL连接配置
      - DB=postgresql+psycopg2://postgres:${POSTGRES_PASSWORD:-your-super-secret-and-long-postgres-password}@${POSTGRES_HOST}:${POSTGRES_PORT:-5432}/${POSTGRES_DB:-postgres}?sslmode=${DB_SSLMODE:-disable}
      # 应用配置
      - APP_NAME=we-mp-rss
      - SERVER_NAME=we-mp-rss
      - WEB_NAME=WeRSS微信公众号订阅助手
      - SECRET_KEY=${SECRET_KEY_BASE:-UpNVntn3cDxHJpq99YMc1T1AQgQpc8kfYTuRgBiYa15BLrx8etQoXz3gZv1/u2oq}
      - USERNAME=admin
      - PASSWORD=admin@123
      - ENABLE_JOB=true
      - THREADS=4
      - PORT=38001
      - DEBUG=false
    ports:
      - "38001:38001"
    volumes:
      - ./data:/app/data
    restart: unless-stopped
    networks:
      - ws-supabase_default
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:38001/api/docs"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_BASE_URL: http://localhost:38001/
    environment:
      - VITE_API_BASE_URL=http://localhost:38001/
    ports:
      - "30000:30000"
    depends_on:
      - backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:30000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  ws-supabase_default:
    external: true
    name: ws-supabase_default
